---
phase: spec-016-code-expressiveness
task: Phase 13 complete, Phase 14 next
total_tasks: 86
completed_tasks: 33
status: between_phases
last_updated: 2026-02-24T12:36:03.470Z
---

<current_state>
Phase 13 (US11 DRY Violations) is fully complete — all 11/11 tasks done, verified, committed, and pushed.
Next up is Phase 14 (US11 Logging & Cleanup — T042, T043, T044).
Working tree is clean. Branch: 016-code-expressiveness. Remote is up to date.
</current_state>

<completed_work>
This session completed Phase 13 Batch 2 (5 tasks):

- T041: Replaced last 'kali' fallback with os.userInfo().username in kismet-control-service-extended.ts
- T082: Verified ad-hoc retry already migrated to withRetry() — no changes needed
- T040: Unified MAC-to-angle hash — DJB2 replaced with FNV-1a, canonical in $lib/utils/geo.ts
- T039: Consolidated 3 haversine implementations into 1 canonical haversineMeters() in $lib/utils/geo.ts
- T037: Migrated 37 inline delay patterns to delay() across 20 source files
- Also fixed T038 gaps: replaced remaining 6371000/111320 magic numbers in map-helpers.ts

New shared module created: src/lib/utils/geo.ts (haversine + MAC hash functions)

Commits:

- 7bbb717 refactor(dry): T037+T039+T040+T041+T082 — Phase 13 Batch 2 migration tasks
- 2fbd15f refactor(dry): T036+T038+T080+T081+T083+T084 — Phase 13 Batch 1 creation tasks (prior session)

Overall progress: 33/86 tasks done (Phases 1-13 complete, plus Phase 8a and 9-10)
</completed_work>

<remaining_work>
Phase 14 — US11 Logging & Cleanup (3 tasks):

- T042: Migrate 60 logError() calls across 22 files to logger.error() — biggest task
- T043: Add dispose()/cleanup methods to 4 setInterval instances lacking cleanup
- T044: Fix 7 remaining unsafe (error as ...) casts using errMsg() + type guards

Phase 15 — US12 Oversized File Decomposition (13 tasks, all [P] parallel):

- T045-T057: Decompose 13 files >300 LOC into focused sub-modules

Phase 16 — Type Safety (5 tasks):

- T058-T060, T085-T086: globalThis types, JSON validation, API interfaces, eslint-disable audit

Phase 17 — Final Verification (7 tasks):

- T061-T067: Full test suite, build, LOC delta, SC verification, bundle size

Phase 18 — Route Migration at Scale (10 tasks):

- T068-T077: Migrate ~60 routes to createHandler() factory in 10 batches

Phase 8b-f — Client Libraries (9 tasks, requires npm install approval):

- T018-T024, T078-T079: data-table, virtua, superforms, svelte-query, fetchJSON wrapper

Total remaining: 53 tasks across 6 phases
</remaining_work>

<decisions_made>

- Created $lib/utils/geo.ts as shared module (not server-only) because client-side map components need haversine/hash functions
- Chose FNV-1a over DJB2 as canonical MAC hash — better distribution for short strings
- server/db/geo.ts calculateDistance() now delegates to shared haversineMeters() (thin wrapper to avoid breaking existing consumers)
- map-helpers.ts re-exports haversineKm from shared module to avoid changing all downstream consumers
- T082 was already done in a prior pass — marked complete without changes
- Test files are exempt from delay() migration (per task spec)
  </decisions_made>

<blockers>
None. All phases are unblocked.
</blockers>

<context>
Execution strategy for remaining phases:
- Phase 14 (T042) is the next big migration (60 logError calls → logger.error). Same mechanical pattern as T037.
- Phase 15 is highly parallelizable (13 independent file decompositions)
- Phase 18 (route migration) depends on Phase 11 (done) but independent of 14/15
- Phase 8b-f requires npm install approval for 4 new packages

Recommended execution order: 14 → 15 → 16 → 18 → 8 → 17
</context>

<next_action>
Start Phase 14 with T042 (logError migration — 60 call sites across 22 files).
Read current logError/logger.error patterns, then dispatch as a single agent task.
Command: /speckit.implement continue on phase 14
</next_action>
