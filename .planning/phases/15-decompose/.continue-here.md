---
phase: 18-route-migration-complete
task: 70
total_tasks: 86
status: in_progress
last_updated: 2026-02-24T16:53:45.623Z
---

<current_state>
Phase 18 (Route Migration at Scale) COMPLETE — 47 routes migrated to createHandler().
Post-migration code review done — found and fixed 3 issues (test crash, unused import, DRY violation).
Branch `016-code-expressiveness` pushed to remote at commit 242efbc.
70/86 total tasks done (81%). 16 remaining across 2 phases.
</current_state>

<completed_work>
This session:

- Phase 18 (T068-T077) — committed as dba2a99: All 47 non-exempt API routes migrated to createHandler() factory. 53 of 66 route files now use factory (SC-004 target: 50+). 13 exempt (7 streaming/SSE/WebSocket, 1 binary proxy, 1 trivial, 4 already migrated).
- Post-review fixes — committed as 242efbc:
    - Hardened createHandler's buildErrorResponse against partial RequestEvent mocks (event.url?.pathname ?? 'unknown')
    - Fixed tak/config/server.test.ts assertion: 'Internal server error' (factory uses lowercase)
    - Removed unused logger import from signals/cleanup/+server.ts
    - Replaced local errMsg() in database/query/+server.ts with shared import

Prior phases (1-16) all complete — 60 tasks.
</completed_work>

<remaining_work>

Phase 8 — US8 Client-Side Libraries (9 tasks):

- T018-T019: Data tables (@tanstack/table-core) — REQUIRES npm install approval
- T020-T021: Virtual scrolling (virtua) — REQUIRES npm install approval
- T022: Form validation (superforms+formsnap) — REQUIRES npm install approval
- T023: Svelte query (optional) — REQUIRES npm install approval
- T024: Unify dual Kismet store architecture — no blockers
- T078: Create fetchJSON<T>() wrapper — no blockers
- T079: Migrate ~37 client-side fetch patterns — depends on T078

Phase 17 — Final Verification (7 tasks):

- T061-T067: Test suite, build, LOC delta, SC validation, madge, bundle, verification report
- Depends on Phase 8 completion

Total remaining: 16 tasks across 2 phases
</remaining_work>

<decisions_made>

- Post-review: Made buildErrorResponse defensive with optional chaining rather than fixing all test mocks — 53 routes use this factory, hardening it protects all future tests
- Post-review: Extracted resolveContext() helper to keep buildErrorResponse under ESLint complexity limit of 5 (each ?? counts as a branch)
- database/query/+server.ts is gitignored (from barrel file cleanup) — must use `git add -f` to stage
- Code review identified pre-existing issues (not introduced by Phase 18): gsm-evil/control returns all errors as 400, hackrf/status returns 200 on error, isInputValidationError duplicated across 4 TAK files, tak/certs InputValidationError guard partially unreachable due to cert-manager wrapping
  </decisions_made>

<blockers>
Memory pressure on RPi 5: Antigravity/VS Code Server consuming 1.17 GB, 3 TypeScript servers at 798 MB, MCP servers + npm wrappers at 834 MB. Total ~5.8 GB used of 8 GB. Running vitest or svelte-check requires waiting for background hooks to clear.

Phase 8b-e blocked on user npm install approval for 4 packages.
</blockers>

<context>
Phase 8 has two unblocked paths:
1. T078-T079 (fetchJSON wrapper + migration) — pure code, no npm installs needed
2. T024 (Kismet store unification) — architectural refactor, no dependencies

Phase 8b-e (T018-T023) requires user to approve: @tanstack/table-core, virtua, sveltekit-superforms+formsnap, @tanstack/svelte-query

Phase 17 verification should run last after all implementation complete.

Memory is a concern — stop Antigravity if not using IDE to free 1.17 GB. The tshark/dumpcap processes (179 MB) can also be killed if no active packet capture.
</context>

<next_action>
Start with T078 (create fetchJSON<T>() wrapper in src/lib/utils/fetch-json.ts) then T079 (migrate 37 fetch patterns). These are unblocked and don't need npm approval.
Or ask user to approve npm packages for Phase 8b-e first.
</next_action>
</content>
</invoke>
