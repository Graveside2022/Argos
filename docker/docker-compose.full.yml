# Argos Full Stack - Unified Docker Compose
# All services required for the complete Argos SDR & Network Analysis Console
#
# Usage:
#   Development: docker compose -f docker/docker-compose.full.yml --profile dev up
#   Production:  docker compose -f docker/docker-compose.full.yml --profile prod up -d
#
# Services included:
#   - Argos SvelteKit App (dev mode with hot reload OR production build)
#   - HackRF Backend (Python Flask API)
#   - Kismet (WiFi scanning and device tracking)
#   - OpenWebRX (SDR web interface)
#   - GPSD (GPS daemon for location data)

version: '3.8'

services:
  # ============================================
  # ARGOS SVELTEKIT APP - DEVELOPMENT MODE
  # ============================================
  argos-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: builder
    image: argos:dev
    container_name: argos-dev
    profiles:
      - dev
    ports:
      - "5173:5173"
      - "24678:24678"  # Vite HMR port
    environment:
      - NODE_ENV=development
      - PORT=5173
      - PUBLIC_BASE_URL=http://localhost:5173
      - PUBLIC_API_BASE_URL=http://localhost:8005
      - PUBLIC_WS_URL=ws://localhost:8005
      - PUBLIC_HACKRF_API_URL=http://hackrf-backend:8092
      - PUBLIC_KISMET_API_URL=http://kismet:2501
      - PUBLIC_OPENWEBRX_URL=http://openwebrx:8073
      - PUBLIC_SPECTRUM_ANALYZER_URL=http://hackrf-backend:8092
      - PUBLIC_HACKRF_WS_URL=ws://hackrf-backend:8092
      - PUBLIC_KISMET_WS_URL=ws://kismet:2501
      - PUBLIC_ENABLE_DEBUG=true
      - PUBLIC_ENABLE_MOCK_DATA=false
    volumes:
      # Mount source code for hot reload
      - ..:/app:rw
      # Exclude node_modules and build artifacts
      - /app/node_modules
      - /app/.svelte-kit
    command: npm run dev -- --host 0.0.0.0
    depends_on:
      - hackrf-backend
    networks:
      - argos-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # ARGOS SVELTEKIT APP - PRODUCTION MODE
  # ============================================
  argos-prod:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: runner
    image: argos:latest
    container_name: argos-prod
    profiles:
      - prod
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=production
      - PORT=5173
      - PUBLIC_BASE_URL=http://localhost:5173
      - PUBLIC_API_BASE_URL=http://localhost:8005
      - PUBLIC_WS_URL=ws://localhost:8005
      - PUBLIC_HACKRF_API_URL=http://hackrf-backend:8092
      - PUBLIC_KISMET_API_URL=http://kismet:2501
      - PUBLIC_OPENWEBRX_URL=http://openwebrx:8073
      - PUBLIC_SPECTRUM_ANALYZER_URL=http://hackrf-backend:8092
      - PUBLIC_HACKRF_WS_URL=ws://hackrf-backend:8092
      - PUBLIC_KISMET_WS_URL=ws://kismet:2501
      - PUBLIC_ENABLE_DEBUG=false
      - PUBLIC_ENABLE_MOCK_DATA=false
    volumes:
      - argos-logs:/app/logs:rw
    depends_on:
      - hackrf-backend
    networks:
      - argos-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5173/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # HACKRF BACKEND - RF Control API
  # ============================================
  hackrf-backend:
    build:
      context: ../hackrf_emitter/backend
      dockerfile: Dockerfile
    image: argos-hackrf-backend:latest
    container_name: hackrf-backend
    ports:
      - "8092:8092"
    environment:
      - PYTHONUNBUFFERED=1
      - FLASK_ENV=production
    # Mount USB for HackRF device access
    devices:
      - "/dev/bus/usb:/dev/bus/usb"
    # For development, uncomment to mount source code:
    # volumes:
    #   - ../hackrf_emitter/backend:/app:rw
    privileged: true  # Required for USB device access
    networks:
      - argos-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8092/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # KISMET - WiFi Scanning & Device Tracking
  # ============================================
  kismet:
    image: kismetwireless/kismet:latest
    container_name: kismet
    ports:
      - "2501:2501"    # Kismet API
      - "3501:3501"    # Kismet Web UI
    environment:
      - KISMET_SERVER_HOST=0.0.0.0
    # Mount USB for WiFi adapters
    devices:
      - "/dev/bus/usb:/dev/bus/usb"
    volumes:
      - kismet-data:/root/.kismet
      - kismet-logs:/var/log/kismet
    cap_add:
      - NET_ADMIN
      - NET_RAW
    network_mode: host  # Required for WiFi monitoring
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # OPENWEBRX - SDR Web Interface
  # ============================================
  openwebrx:
    image: slechev/openwebrxplus:latest
    container_name: openwebrx
    ports:
      - "8073:8073"
    environment:
      - OPENWEBRX_ADMIN_USER=admin
      - OPENWEBRX_ADMIN_PASSWORD=${OPENWEBRX_PASSWORD:-admin}
    # Mount USB for SDR devices
    devices:
      - "/dev/bus/usb:/dev/bus/usb"
    volumes:
      - openwebrx-settings:/var/lib/openwebrx
      - openwebrx-config:/etc/openwebrx
    tmpfs:
      - /tmp/openwebrx:rw,noexec,nosuid,size=100m
    networks:
      - argos-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # GPSD - GPS Daemon
  # ============================================
  gpsd:
    image: knowhowlab/gpsd:latest
    container_name: gpsd
    ports:
      - "2947:2947"
    # Mount GPS device (adjust device path as needed)
    devices:
      - "/dev/ttyUSB0:/dev/ttyUSB0"
      - "/dev/ttyACM0:/dev/ttyACM0"
    environment:
      - GPS_DEVICES=/dev/ttyUSB0,/dev/ttyACM0
      - GPSD_OPTIONS=-n
    networks:
      - argos-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ============================================
# NETWORKS
# ============================================
networks:
  argos-network:
    driver: bridge
    name: argos-network

# ============================================
# VOLUMES
# ============================================
volumes:
  argos-logs:
    name: argos-logs
  kismet-data:
    name: kismet-data
  kismet-logs:
    name: kismet-logs
  openwebrx-settings:
    name: openwebrx-settings
  openwebrx-config:
    name: openwebrx-config
