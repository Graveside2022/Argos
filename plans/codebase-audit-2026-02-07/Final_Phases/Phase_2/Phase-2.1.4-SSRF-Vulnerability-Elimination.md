# Phase 2.1.4: SSRF Vulnerability Elimination

**Classification**: UNCLASSIFIED // FOUO
**Document Version**: 1.0
**Created**: 2026-02-08
**Authority**: Codebase Audit 2026-02-07, Final Phases
**Standards Compliance**: OWASP A10:2021 (Server-Side Request Forgery), CWE-918 (Server-Side Request Forgery), NIST SP 800-53 SC-7 (Boundary Protection), DISA STIG V-222609 (Application must restrict URI access)
**Review Panel**: US Cyber Command Engineering Review Board

---

## Purpose

This task eliminates Server-Side Request Forgery (SSRF) vulnerabilities by replacing an open HTTP proxy with an explicit endpoint allowlist and by validating all parameters passed to external API calls. SSRF allows an attacker to make the Argos server issue requests to arbitrary internal or external endpoints, potentially accessing services on the loopback interface or internal network that should not be reachable.

## Execution Constraints

| Constraint       | Value                                                                    |
| ---------------- | ------------------------------------------------------------------------ |
| Risk Level       | LOW -- may break valid proxy paths not currently in allowlist            |
| Severity         | HIGH                                                                     |
| Prerequisites    | Task 2.1.1 (authentication), Task 2.1.2 (input sanitization library)     |
| Files Touched    | 3 files modified                                                         |
| Blocks           | None directly                                                            |
| Blocked By       | Task 2.1.1 (auth), Task 2.1.2 (sanitization library provides validators) |
| Estimated Effort | 1 hour                                                                   |

## Threat Context

Argos runs on a Raspberry Pi 5 that hosts multiple services on localhost: Kismet (port 2501), HackRF backend (port 3002/8092), gpsd (port 2947), GSM Evil, Bettercap, and OpenWebRX (port 8073). The tactical network segment may also contain other military systems with internal services.

**SSRF vector #1**: The file `src/routes/api/hackrf/[...path]/+server.ts` acts as an open HTTP proxy to `localhost:3002`. Any path is accepted and forwarded -- an attacker can use this to reach ANY endpoint on the HackRF backend by crafting the path, including endpoints that were not intended to be exposed through the Argos frontend.

**SSRF vector #2**: The files `src/routes/api/gsm-evil/tower-location/+server.ts` and `src/routes/api/cell-towers/nearby/+server.ts` pass user-supplied latitude, longitude, and radius parameters to the external OpenCellID API. Without numeric validation, an attacker could inject non-numeric values that alter the API request in unexpected ways.

## Current State Assessment

| Metric                                   | Value | Verification Command                                                                             |
| ---------------------------------------- | ----- | ------------------------------------------------------------------------------------------------ |
| Open proxy endpoints (catch-all `[...]`) | 1     | `find src/routes/api/ -name "[...path]" -type d \| wc -l`                                        |
| HackRF proxy file exists                 | YES   | `test -f "src/routes/api/hackrf/[...path]/+server.ts" && echo YES`                               |
| Path validation in proxy                 | NONE  | `grep -c "allowlist\|ALLOWED\|whitelist" "src/routes/api/hackrf/[...path]/+server.ts"` returns 0 |
| External API calls with user params      | 2     | `tower-location/+server.ts` and `cell-towers/nearby/+server.ts`                                  |
| Numeric validation on lat/lon parameters | NONE  | `grep -c "validateNumeric" src/routes/api/cell-towers/ --include="*.ts"` returns 0               |

## Implementation Plan

### Subtask 2.1.4.1: Fix HackRF Proxy Catch-All

**File**: `src/routes/api/hackrf/[...path]/+server.ts` (EXISTS, verified)

This file currently acts as an unrestricted HTTP proxy to the HackRF backend on `localhost:3002`. Any path segment is forwarded without validation. This must be replaced with an explicit allowlist of permitted endpoint paths.

BEFORE (vulnerable):

```typescript
// src/routes/api/hackrf/[...path]/+server.ts -- current state
// ANY path is forwarded to localhost:3002. No restrictions.
export async function GET({ params, request }) {
	const path = params.path;
	// Open proxy -- path is unvalidated
	const response = await fetch(`http://localhost:3002/${path}`, {
		headers: request.headers
	});
	return new Response(response.body, {
		status: response.status,
		headers: response.headers
	});
}

export async function POST({ params, request }) {
	const path = params.path;
	// Same open proxy for POST requests
	const response = await fetch(`http://localhost:3002/${path}`, {
		method: 'POST',
		headers: request.headers,
		body: request.body
	});
	return new Response(response.body, {
		status: response.status,
		headers: response.headers
	});
}
```

AFTER (secure):

```typescript
// src/routes/api/hackrf/[...path]/+server.ts -- secured with allowlist
import { json } from '@sveltejs/kit';

const ALLOWED_PATHS = [
	'status',
	'start-sweep',
	'stop-sweep',
	'device-info',
	'data-stream',
	'cycle-frequency',
	'emergency-stop'
] as const;

function validateProxyPath(path: string): boolean {
	return ALLOWED_PATHS.includes(path as (typeof ALLOWED_PATHS)[number]);
}

export async function GET({ params, request }) {
	const path = params.path;
	if (!validateProxyPath(path)) {
		return json({ error: 'Endpoint not allowed' }, { status: 404 });
	}
	const response = await fetch(`http://localhost:3002/${path}`, {
		headers: request.headers
	});
	return new Response(response.body, {
		status: response.status,
		headers: response.headers
	});
}

export async function POST({ params, request }) {
	const path = params.path;
	if (!validateProxyPath(path)) {
		return json({ error: 'Endpoint not allowed' }, { status: 404 });
	}
	const response = await fetch(`http://localhost:3002/${path}`, {
		method: 'POST',
		headers: request.headers,
		body: request.body
	});
	return new Response(response.body, {
		status: response.status,
		headers: response.headers
	});
}
```

**Key behaviors**:

1. Only 7 explicitly listed paths are forwarded to the HackRF backend
2. Any other path returns HTTP 404 with a generic error message (no information leakage about backend structure)
3. The `as const` assertion ensures TypeScript enforces the allowlist at compile time
4. New HackRF backend endpoints must be explicitly added to `ALLOWED_PATHS` before they are accessible through the proxy

**Maintaining the allowlist**: If the HackRF backend adds new endpoints, update `ALLOWED_PATHS` and increment the document version. Each addition must be justified with a description of the endpoint's purpose.

### Subtask 2.1.4.2: Validate External API Parameters

For both files that call the external OpenCellID API, add numeric validation using the input sanitization library created in Task 2.1.2.

**File 1**: `src/routes/api/gsm-evil/tower-location/+server.ts`

BEFORE (vulnerable):

```typescript
// tower-location/+server.ts -- lat/lon passed to external API without validation
const lat = url.searchParams.get('lat');
const lon = url.searchParams.get('lon');
const radius = url.searchParams.get('radius');
// These are passed directly to OpenCellID API URL construction
const apiUrl = `https://opencellid.org/cell/getInArea?lat=${lat}&lon=${lon}&radius=${radius}&...`;
```

AFTER (secure):

```typescript
import { validateNumericParam } from '$lib/server/security/input-sanitizer';

const lat = validateNumericParam(url.searchParams.get('lat'), 'latitude', -90, 90);
const lon = validateNumericParam(url.searchParams.get('lon'), 'longitude', -180, 180);
const radius = validateNumericParam(url.searchParams.get('radius'), 'radius', 0.1, 50);
// Only validated numeric values reach the API URL construction
const apiUrl = `https://opencellid.org/cell/getInArea?lat=${lat}&lon=${lon}&radius=${radius}&...`;
```

**File 2**: `src/routes/api/cell-towers/nearby/+server.ts`

BEFORE (vulnerable):

```typescript
// cell-towers/nearby/+server.ts -- same pattern as above
const lat = url.searchParams.get('lat');
const lon = url.searchParams.get('lon');
// Passed to external API without validation
```

AFTER (secure):

```typescript
import { validateNumericParam } from '$lib/server/security/input-sanitizer';

const lat = validateNumericParam(url.searchParams.get('lat'), 'latitude', -90, 90);
const lon = validateNumericParam(url.searchParams.get('lon'), 'longitude', -180, 180);
```

**Validation ranges**:

| Parameter | Minimum | Maximum | Rationale                                       |
| --------- | ------- | ------- | ----------------------------------------------- |
| latitude  | -90     | 90      | Valid geographic latitude range                 |
| longitude | -180    | 180     | Valid geographic longitude range                |
| radius    | 0.1     | 50      | 0.1 km minimum resolution; 50 km maximum search |

## Verification Checklist

1. `grep -c "ALLOWED_PATHS" "src/routes/api/hackrf/[...path]/+server.ts"` returns `1` (allowlist defined)
2. `curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: $ARGOS_API_KEY" http://localhost:5173/api/hackrf/status` returns `200` (allowed path works)
3. `curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: $ARGOS_API_KEY" http://localhost:5173/api/hackrf/../../etc/passwd` returns `404` (path traversal blocked)
4. `curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: $ARGOS_API_KEY" http://localhost:5173/api/hackrf/arbitrary-endpoint` returns `404` (unlisted path blocked)
5. `grep -c "validateNumericParam" src/routes/api/gsm-evil/tower-location/+server.ts` returns at least `2` (lat and lon validated)
6. `grep -c "validateNumericParam" src/routes/api/cell-towers/nearby/+server.ts` returns at least `2` (lat and lon validated)
7. `npm run typecheck` exits 0
8. `npm run build` exits 0

## Commit Strategy

```
security(phase2.1.4): eliminate SSRF vectors with path allowlist and param validation

Phase 2.1 Task 4: SSRF Vulnerability Elimination
- Replaced open HackRF proxy catch-all with 7-entry ALLOWED_PATHS allowlist
- Added validateNumericParam for lat/lon/radius in tower-location and cell-towers endpoints
- Unlisted proxy paths now return 404 (no backend structure leakage)
Verified: curl to unlisted HackRF path returns 404; lat/lon validation active

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
```

## Rollback Strategy

```bash
git reset --soft HEAD~1
```

To fully revert:

```bash
git reset --hard HEAD~1
```

Note: After rollback, the HackRF proxy returns to its open state (any path forwarded) and external API parameters are unvalidated. This is acceptable only if the system is taken offline.

## Risk Assessment

| Risk                                                       | Likelihood | Impact | Mitigation                                                       |
| ---------------------------------------------------------- | ---------- | ------ | ---------------------------------------------------------------- |
| Valid HackRF backend path not in allowlist                 | MEDIUM     | LOW    | Add paths to ALLOWED_PATHS as discovered; document new additions |
| Radius validation too restrictive for use case             | LOW        | LOW    | 50 km maximum is generous for tactical cell tower lookup         |
| Proxy refactoring breaks SSE/streaming from HackRF backend | LOW        | MEDIUM | data-stream is included in allowlist; test streaming end-to-end  |

## Standards Traceability

| Standard            | Requirement                                                 | How This Task Satisfies It                                                          |
| ------------------- | ----------------------------------------------------------- | ----------------------------------------------------------------------------------- |
| OWASP A10:2021      | Server-Side Request Forgery -- restrict URL destinations    | Open proxy replaced with explicit 7-path allowlist                                  |
| CWE-918             | SSRF -- prevent attacker-controlled requests from server    | Path validation rejects any path not in allowlist; numeric validation on API params |
| NIST SP 800-53 SC-7 | Boundary Protection -- control communications at boundaries | Proxy now acts as explicit gateway with defined allowed paths                       |
| DISA STIG V-222609  | Application must restrict URI access                        | Only 7 specific URIs permitted through proxy; all others return 404                 |

## Execution Tracking

| Subtask | Description                      | Status  | Started | Completed | Verified By |
| ------- | -------------------------------- | ------- | ------- | --------- | ----------- |
| 2.1.4.1 | Fix HackRF proxy catch-all       | PENDING | --      | --        | --          |
| 2.1.4.2 | Validate external API parameters | PENDING | --      | --        | --          |
