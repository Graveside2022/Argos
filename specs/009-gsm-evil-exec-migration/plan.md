# Implementation Plan: GSM Evil & Kismet Extended — Safe Exec Migration

**Branch**: `009-gsm-evil-exec-migration` | **Date**: 2026-02-19 | **Spec**: `specs/009-gsm-evil-exec-migration/spec.md`
**Input**: Feature specification + deep audit of 91 legacyShellExec call sites across 12 files

## Summary

Migrate all 91 `legacyShellExec` call sites in the GSM Evil subsystem (11 files) and Kismet Extended service (1 file) from unsafe shell execution to safe `execFileAsync`/`spawn`/Node.js API equivalents. This eliminates the last shell injection vectors in the Argos codebase and allows deletion of the `legacyShellExec` shim.

## Technical Context

**Language/Version**: TypeScript 5.8 (strict mode)
**Primary Dependencies**: SvelteKit 2.22, child_process (execFile, spawn), better-sqlite3, fs/promises
**Storage**: SQLite via better-sqlite3 (replaces inline Python sqlite3 calls)
**Testing**: Vitest (163 unit + 36 security tests), typecheck, build verification
**Target Platform**: Raspberry Pi 5, Kali Linux 2025.4 (aarch64), native host
**Project Type**: Web application (SvelteKit full-stack)
**Performance Goals**: No regression — exec→execFile has negligible latency difference
**Constraints**: RPi 5 with 8GB RAM, earlyoom active, max 1024MB Node.js heap (dev: 2048MB)
**Scale/Scope**: 91 call sites across 12 files, 5 migration patterns, 5 security gaps to fix

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Article                             | Requirement                       | Status | Notes                                                                                                      |
| ----------------------------------- | --------------------------------- | ------ | ---------------------------------------------------------------------------------------------------------- |
| I-1.1 Comprehension Lock            | Understand before coding          | PASS   | Deep audit of all 91 call sites complete                                                                   |
| I-1.2 Codebase Inventory            | Search existing implementations   | PASS   | All 12 files cataloged with line numbers                                                                   |
| II-2.1 TypeScript Strict            | strict: true, no any              | PASS   | All replacements use typed APIs                                                                            |
| II-2.2 Modularity                   | Max 300 lines/file                | WATCH  | GSM Evil services already exceed; not adding lines                                                         |
| II-2.4 Error Handling               | Explicit handling                 | PASS   | try/catch replaces `\|\| true` / `2>/dev/null`                                                             |
| II-2.6 Forbidden: No service layers | No wrapper abstractions           | PASS   | Direct execFile/spawn calls, no wrapper                                                                    |
| III-3.1 Test-First                  | Tests before implementation       | WAIVED | Spec notes: "no dedicated GSM Evil unit tests — regression relies on TypeScript compilation + integration" |
| VIII-8.1 Security                   | Validate all inputs               | PASS   | 5 validation gaps identified and planned for fix                                                           |
| IX-9.2 Task Granularity             | 1 task = 1 commit, max 2h/5 files | PASS   | Tasks organized per-file, sequential                                                                       |

## Project Structure

### Documentation (this feature)

```text
specs/009-gsm-evil-exec-migration/
├── plan.md              # This file
├── research.md          # Deep audit findings (91 call sites)
├── spec.md              # Feature specification
├── quickstart.md        # Integration scenarios
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (files modified)

```text
src/
├── lib/
│   └── server/
│       ├── legacy-shell-exec.ts          # DELETED after all migrations
│       └── services/
│           ├── gsm-evil/
│           │   ├── gsm-evil-control-service.ts      # 19 calls → execFile/spawn/fs
│           │   ├── gsm-intelligent-scan-service.ts   # 16 calls → execFile/spawn/fs
│           │   ├── gsm-scan-service.ts               # 10 calls → execFile/spawn/fs
│           │   └── gsm-evil-health-service.ts        # 10 calls → execFile/fetch/sqlite3
│           └── kismet/
│               └── kismet-control-service-extended.ts # 16 calls → execFile/spawn/fetch/fs
└── routes/
    └── api/
        └── gsm-evil/
            ├── activity/+server.ts            # 4 calls → execFile/fs
            ├── imsi-data/+server.ts           # 2 calls → fs/sqlite3
            ├── imsi/+server.ts                # 2 calls → fs/sqlite3
            ├── status/+server.ts              # 5 calls → execFile/fetch
            ├── live-frames/+server.ts         # 1 call  → execFile
            ├── frames/+server.ts              # 2 calls → execFile/fs
            └── intelligent-scan/+server.ts    # 4 calls → execFile/spawn
```

**Structure Decision**: No new files created (except possible extracted Python scripts). All changes are in-place migrations within existing files. `legacy-shell-exec.ts` deleted as final task.

## Migration Patterns (from research.md)

### Pattern A: Error Suppression → try/catch (~40 calls)

```
BEFORE: legacyShellExec('pgrep -x kismet 2>/dev/null || true')
AFTER:  try { await execFileAsync('/usr/bin/pgrep', ['-x', 'kismet']) } catch { return '' }
```

### Pattern B: Pipe Chain → Single Command + JS Parse (~20 calls)

```
BEFORE: legacyShellExec('ps aux | grep X | grep -v grep | head -1')
AFTER:  const { stdout } = await execFileAsync('/usr/bin/pgrep', ['-af', 'X']); return stdout.split('\n')[0]
```

### Pattern C: Background + PID → spawn() (5 calls)

```
BEFORE: legacyShellExec('sudo setsid nohup cmd >/dev/null 2>&1 & echo $!')
AFTER:  const child = spawn('/usr/bin/sudo', [...args], { detached: true, stdio: ['ignore', logFd, logFd] }); child.unref(); return child.pid
```

### Pattern D: Inline Python SQL → better-sqlite3 (4 calls)

```
BEFORE: legacyShellExec('python3 -c "import sqlite3; ..."')
AFTER:  const db = new Database(dbPath, { readonly: true }); const row = db.prepare(sql).get(); db.close()
```

### Pattern E: Shell File Operations → fs/fetch (varies)

```
BEFORE: legacyShellExec('test -f path && echo ok || echo missing')
AFTER:  try { await fs.access(path); return 'ok' } catch { return 'missing' }

BEFORE: legacyShellExec('curl -s URL')
AFTER:  const res = await fetch(url, { signal: AbortSignal.timeout(3000) })
```

## Execution Strategy

### Phase 1: Security Gaps (fix validation before migration)

Add missing `validateNumericParam()`, `validateInterfaceName()`, and path validation to the 5 identified gaps. This ensures all dynamic values are validated regardless of whether migration happens.

### Phase 2: Simple Migrations (routes with static commands)

Migrate the 7 GSM Evil API routes. Most use static commands or already-validated parameters. Low risk, high volume (20 call sites).

### Phase 3: Service File Migrations (complex shell patterns)

Migrate the 4 GSM Evil services. These contain the hardest patterns: background processes, inline Python, pipe chains, sed scripting. High complexity, 55 call sites.

### Phase 4: Kismet Extended Migration

Migrate kismet-control-service-extended.ts. Contains the credential-via-curl pattern (→ fetch) and the kismet daemonization via bash -c (→ spawn). 16 call sites.

### Phase 5: Cleanup & Verification

Delete `legacy-shell-exec.ts`, verify zero legacyShellExec imports remain, run full test suite.

### Phase 6: Carryover Items

Fix map-setup.ts setTimeout, add sudoers documentation. Low-effort items from 008 review.

## Risk Assessment

| Risk                                               | Likelihood | Impact                          | Mitigation                                        |
| -------------------------------------------------- | ---------- | ------------------------------- | ------------------------------------------------- |
| Background process PID capture fails with spawn()  | Medium     | High — GSM scanning won't start | Test spawn().pid on RPi 5 before full migration   |
| better-sqlite3 DB path differs from Python sqlite3 | Low        | Medium — IMSI queries fail      | Validate path resolution matches between runtimes |
| sudo requires password prompt (not in sudoers)     | Low        | High — all sudo calls fail      | Document required sudoers entries                 |
| Kismet daemonization fails without bash -c wrapper | Medium     | High — Kismet won't start       | Test spawn with detached + cwd option first       |
| OOM during large file edits (RPi 5 constraint)     | Low        | Medium — session crashes        | Lock-based typecheck hook already mitigates       |

## Complexity Tracking

No constitution violations requiring justification. All changes are security migrations within existing files.
