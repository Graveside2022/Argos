# Implementation Plan: Complexity Reduction

**Branch**: `015-complexity-reduction` | **Date**: 2026-02-23 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/015-complexity-reduction/spec.md`

## Summary

Systematically refactor all functions across the codebase to bring all cyclomatic and cognitive complexity scores to 5 or below. Approximately 536 violations at this threshold. Purely structural refactoring — no feature changes, no API changes, no behavioral modifications. Techniques: extract focused helpers, replace conditional chains with lookup tables, use early returns to flatten nesting, decompose large orchestrators into pipeline stages.

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode)
**Primary Dependencies**: SvelteKit, eslint-plugin-sonarjs, better-sqlite3
**Storage**: N/A (no schema changes)
**Testing**: Vitest (unit, integration, performance suites)
**Target Platform**: Raspberry Pi 5 / Kali Linux (ARM64)
**Project Type**: SvelteKit web application
**Performance Goals**: No regression — all existing performance benchmarks must continue to pass
**Constraints**: Max 300 lines/file, max 50 lines/function (Constitution Article 2.2). No new dependencies.
**Scale/Scope**: ~536 violations across the codebase. ESLint enforced at error level, threshold 5.

## Constitution Check

_GATE: All gates pass._

| Article                | Requirement                         | Status                                                     |
| ---------------------- | ----------------------------------- | ---------------------------------------------------------- |
| 1.1 Comprehension Lock | Understand before coding            | PASS — Full violation inventory compiled with exact scores |
| 1.2 Codebase Inventory | Search before modifying             | PASS — Each function identified by file:line:score         |
| 2.1 TypeScript Strict  | No `any`, strict mode               | PASS — Refactoring preserves existing types                |
| 2.2 Modularity         | ≤50 lines/function, ≤300 lines/file | PASS — This spec explicitly enforces these limits          |
| 2.3 Naming             | Conventions followed                | PASS — Extracted helpers will follow camelCase             |
| 2.4 Error Handling     | Explicit, no swallowed errors       | PASS — FR-009 requires error handling preservation         |
| 2.6 Forbidden Patterns | No barrel files, no catch-all utils | PASS — No new barrel files; helpers are domain-scoped      |
| 3.1 Test-First         | Tests before implementation         | N/A — Pure refactoring; existing tests verify behavior     |
| 3.3 Quality            | Tests independent, deterministic    | PASS — No test changes unless refactored file splits       |
| 5.1-5.3 Performance    | Budgets respected                   | PASS — Performance benchmarks validate no regression       |
| 9.2 Task Granularity   | 1 task ≤ 2 hours, ≤ 5 files         | PASS — Each task targets 1-3 functions in 1-2 files        |
| 9.3 Git Workflow       | 1 commit per task                   | PASS — Each function/group gets its own commit             |

## Project Structure

### Documentation (this feature)

```text
specs/015-complexity-reduction/
├── plan.md              # This file
├── research.md          # Refactoring patterns and strategies
├── spec.md              # Feature specification
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (affected areas — 536 violations across 185 files at threshold 5)

```text
src/
├── lib/
│   ├── components/dashboard/     # ~50 violations: map (17), panels (23), status (11), tak (7), agent-chat, terminal
│   ├── components/gsm-evil/      # 4 violations: ScanResultsTable, TowerTable
│   ├── stores/                   # 15 violations: agent-context-store (35), terminal-store, kismet-store, etc.
│   ├── hackrf/sweep-manager/     # 31 violations across 10 files
│   ├── kismet/                   # 11 violations: websocket-handlers
│   ├── map/                      # 4 violations: symbol-factory, satellite-layer, visibility-engine
│   ├── tactical-map/             # 6 violations: gps-service, kismet-service
│   ├── websocket/                # 4 violations: base.ts
│   ├── utils/                    # 17 violations across 9 files
│   ├── data/                     # 2 violations: tool-hierarchy
│   ├── schemas/                  # 1 violation: api.ts
│   ├── server/
│   │   ├── agent/                # 7 violations: runtime, tools, frontend-tools
│   │   ├── db/                   # 24 violations across 8 files
│   │   ├── hardware/             # 23 violations: detection (15), resource-manager, registry, etc.
│   │   ├── kismet/               # 33 violations across 7 files
│   │   ├── mcp/                  # 60 violations: servers (44), dynamic-tools (16)
│   │   ├── services/             # 67 violations: gsm-evil (30), kismet (9), gps (16), hardware (6), cell-towers (3)
│   │   ├── middleware/           # 5 violations: ws-connection-handler, rate-limit
│   │   ├── hackrf/               # 5 violations: sweep-cycle-init, sweep-coordinator
│   │   ├── gsm/                  # 6 violations: l3-decoder, l3-message-decoders
│   │   ├── tak/                  # 12 violations across 4 files
│   │   └── security/             # 1 violation: auth-audit
├── hooks.server.ts               # 2 violations: handle middleware
├── routes/
│   ├── api/                      # 79 violations across 37 route files
│   ├── dashboard/                # 2 violations: +page.svelte
│   └── gsm-evil/                 # 12 violations: page-logic, +page.svelte
```

**Structure Decision**: No structural changes. All refactoring happens in-place within existing files. Helper functions are extracted into the same file or a co-located `-helpers.ts` module if the parent file would exceed 300 lines.

## Refactoring Strategy

### Pattern Catalog

Each violation will be addressed using one or more of these patterns:

| Pattern                      | When to Use                                    | Complexity Reduction                          |
| ---------------------------- | ---------------------------------------------- | --------------------------------------------- |
| **Early Return**             | Deep nesting from guard checks                 | Removes 1-3 nesting levels per guard          |
| **Lookup Table**             | if-else chains with 3+ branches mapping values | Replaces N branches with 1 lookup (O(1))      |
| **Extract Helper**           | Function does multiple distinct things         | Splits into focused functions ≤5 each         |
| **Strategy Map**             | Conditional behavior dispatch                  | Replaces N if-else with keyed dispatch        |
| **Pipeline Composition**     | Sequential data transformations                | Replaces nested transforms with chained steps |
| **Error Handler Extraction** | try-catch around multiple operations           | Isolates error handling per operation         |

### Execution Order

Functions are grouped by **file proximity** (not just severity) to minimize context switching:

1. **Dashboard map cluster** (map-geojson, map-handlers) — highest cyclomatic scores (35, 29)
2. **Server services cluster** (hardware-details, kismet.service, gsm-evil services) — cognitive hotspots
3. **API route handlers** (gsm-evil/_, system/_, tak/_, gps/_) — moderate complexity, similar patterns
4. **MCP servers** (system-inspector, hardware-debugger, dynamic-server-tools) — isolated modules
5. **Agent cluster** (runtime, tools) — highest cognitive in AI subsystem
6. **Hooks + remaining** (hooks.server.ts, page components, stores) — mixed severity
7. **Final verification** — full lint, build, test suite

### File Size Management

When extracting helpers causes a file to exceed 300 lines:

- Create `<filename>-helpers.ts` in the same directory
- Move pure helper functions to the helpers file
- Keep the main orchestrator in the original file
- Import helpers explicitly (no barrel files)

## Verification Protocol

After each task:

1. `npx eslint <file> --config config/eslint.config.js` — confirm zero complexity errors
2. `npx tsc --noEmit <file>` — confirm zero type errors
3. `npx vitest run <related-test>` — confirm behavioral correctness (if tests exist)

After each phase:

1. `npm run build` — full production build
2. `npx vitest run --no-coverage` — full test suite

Final:

1. `npx eslint src/ --config config/eslint.config.js 2>&1 | grep -c "complexity"` — must be 0
2. `npm run build` — clean build
3. Full test suite — all pass

## Complexity Tracking

No constitution violations. This spec exists specifically to bring the codebase into compliance with Article 2.2 modularity requirements and the newly enforced complexity thresholds.
