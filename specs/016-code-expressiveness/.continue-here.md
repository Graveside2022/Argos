---
phase: 016-code-expressiveness
task: Phase 13 Batch 2 (T037, T039, T040, T041, T082)
total_tasks: 86
completed_tasks: 36
status: in_progress
last_updated: 2026-02-24T13:15:00.000Z
---

<current_state>
Phase 13 Batch 1 (parallel creation tasks) COMPLETE. 6 of 11 Phase 13 tasks done.
36 of 86 total tasks done. Build passes clean. NOT YET COMMITTED.
Branch: 016-code-expressiveness.
</current_state>

<completed_work>

- Phases 1-7, 9-12: Done (prior sessions — 30 tasks)
- T036: Created `src/lib/utils/delay.ts` — shared delay() utility
- T038: Added `GEO.METERS_PER_DEGREE_LAT` to limits.ts, updated geo.ts to use it
- T080: Extracted `kismet-geo-helpers.ts` — shared FNV-1a hashMAC/hashMAC2/signalToDistance/offsetGps/computeFallbackLocation. Removed duplicates from kismet.service.ts (4 private statics) and devices/+server.ts (3 local functions). Both now import from shared module.
- T081: Added `hasValidGpsCoords()` to geo.ts. Removed `hasValidLocation` from KismetService class. Updated kismet.service.ts (2 call sites) and devices/+server.ts (extractGpsCoords + resolveDeviceLocation) to use canonical function.
- T083: Converted `decodeCC` and `decodeSMS` in l3-message-decoders.ts from switch/case to `CC_MESSAGES` and `SMS_MESSAGES` lookup tables
- T084: Added `GPSD_SOCKET_PATH` env var to env.ts schema (default: /var/run/gpsd.sock), updated serial-detector.ts to use `env.GPSD_SOCKET_PATH`, updated .env.example
  </completed_work>

<remaining_work>

Phase 13 Batch 2 — Sequential migration tasks (START HERE):

- T037: Migrate 38 inline `new Promise(resolve => setTimeout(resolve, N))` to delay() — 21 files
- T039: Consolidate 5 haversine implementations. IMPORTANT: calculateDistance() is in server-only geo.ts — client-side consumers (map-helpers.ts, status-bar-data.ts) need a shared haversine in `$lib/utils/` or the functions must stay local. Options: (a) move calculateDistance to $lib/utils/geo.ts, (b) keep client haversines local but import GEO constants
- T040: Unify 3 MAC-to-angle hash algorithms — CORRECTNESS BUG. map-helpers.ts macToAngle uses DJB2, kismet-geo-helpers.ts hashMAC uses FNV-1a. Need to make map-helpers.ts use FNV-1a from kismet-geo-helpers.ts. BUT kismet-geo-helpers.ts is server-only ($lib/server/). Options: (a) move hash functions to $lib/utils/mac-hash.ts (shared), (b) duplicate FNV-1a in map-helpers.ts with comment
- T041: Replace `process.env.USER || 'kali'` on line 183 of kismet-control-service-extended.ts (line 76 already done in prior session)
- T082: Migrate ad-hoc retry in kismet-control-service-extended.ts to withRetry()

Then Phase 14 (T042-T044), Phase 8f (T078-T079), then Phase 18 (T068-T077).
</remaining_work>

<decisions_made>

- T038 partial: Only geo.ts METERS_PER_DEGREE_LAT updated. The 4 hardcoded `6371000` in map-helpers.ts:105, status-bar-data.ts:95, and kismet.service.ts are now handled via kismet-geo-helpers.ts (uses GEO.EARTH_RADIUS_M). map-helpers.ts:105 (createRingPolygon) still has local `earthRadius = 6371000` — needs T039 to address
- T080: locationResolver static property kept (used by buildSimplifiedDevice/buildRawDevice transform helpers)
- T081: extractGpsCoords kept as local function in devices/+server.ts — it wraps hasValidGpsCoords with the null-coalesce-to-zero logic specific to that route's data shape
- T039/T040 architectural issue: Several shared functions live in $lib/server/ but have client-side consumers. Next session should consider moving pure math functions (haversine, MAC hash) to $lib/utils/ for true sharing
  </decisions_made>

<blockers>

- Phase 8b-e blocked on user approval for 4 npm package installs
- RPi 5 memory: 82% usage, avoid parallel agents — do Batch 2 sequentially
- T039/T040 need architectural decision on server vs shared location for pure math functions
  </blockers>

<next_action>
Commit Batch 1 work, then start T037 (delay migration — mechanical, touches 21 files).
Before T039/T040, decide: move pure math to $lib/utils/ or keep server-only with client duplicates.
</next_action>
</content>
</invoke>
