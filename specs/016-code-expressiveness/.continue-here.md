---
phase: 016-code-expressiveness
task: Phase 13 next (T036)
total_tasks: 87
completed_tasks: 28
status: in_progress
last_updated: 2026-02-24T11:34:24.572Z
---

<current_state>
Phases 11+12 (env centralization + hardcoded paths/URLs) are COMPLETE and committed.
28 of 87 tasks done. 59 remaining. Next up: Phase 13 (DRY violations).
Branch: 016-code-expressiveness. Two commits this session:

- 944e693: feat(env): T031+T032+T033+T034+T035
- 35d981b: docs(spec-016): mark Phase 11+12 tasks complete
  </current_state>

<completed_work>

- Phases 1-7, 9-10: Done (prior sessions — 23 tasks)
- Phase 11 T031: Expanded env.ts Zod schema from 4 to 19 vars (Kismet auth, API keys, public URLs, service URLs, GSMEVIL_DIR, ARGOS_TEMP_DIR)
- Phase 11 T032: Migrated 33 process.env accesses across 14 non-MCP files to typed env import
- Phase 11 T033: ARGOS_TEMP_DIR runtime resolution with mkdirSync at startup
- Phase 12 T034: Replaced 17 hardcoded /tmp/ paths with path.join(env.ARGOS_TEMP_DIR, filename)
- Phase 12 T035: Replaced 14 hardcoded localhost:NNNN URLs with env-backed constants
- Verification: tsc clean, npm run build passes, grep confirms zero process.env/tmp/localhost violations
  </completed_work>

<remaining_work>

Phase 13 — DRY Violations (11 tasks, START HERE):

- T036 [P]: Create src/lib/utils/delay.ts
- T037: Migrate 38 inline delay patterns to delay()
- T038 [P]: GEO constants (EARTH_RADIUS_M, METERS_PER_DEGREE_LAT) in limits.ts
- T039: Consolidate 5 haversine implementations to canonical calculateDistance()
- T040: Unify 3 MAC-to-angle hash algorithms (CORRECTNESS BUG — same MAC gives different angles)
- T041 [P]: Replace process.env.USER||'kali' with os.userInfo().username (NOTE: line 76 already done in T032, check line 183)
- T080 [P]: Extract kismet-geo-helpers.ts shared module
- T081 [P]: Consolidate GPS coordinate validation
- T082 [P]: Migrate ad-hoc retry in kismet-control-service-extended to withRetry()
- T083 [P]: Replace switch/case in l3-message-decoders.ts with lookup table
- T084 [P]: Make /var/run/gpsd.sock configurable via env var

Phase 14 — Logging & Cleanup (3 tasks):

- T042: Migrate 60 logError() calls to logger.error()
- T043 [P]: Add dispose/cleanup to 4 setInterval instances
- T044 [P]: Fix 7 remaining unsafe error casts

Phase 8f — Client Fetch Wrapper (2 tasks, no install needed):

- T078 [P]: Create fetchJSON<T>() utility
- T079: Migrate 37 client fetch patterns

Phase 8b-e — Client Libraries (7 tasks, NEED USER APPROVAL for npm installs):

- T018-T019: @tanstack/table-core
- T020-T021: virtua
- T022: sveltekit-superforms + formsnap
- T023-T024: @tanstack/svelte-query + Kismet store unification

Phase 15 — File Decomposition (13 tasks, all [P]):

- T045-T057: 13 oversized files to split

Phase 16 — Type Safety (5 tasks):

- T058-T060, T085-T086

Phase 18 — Route Migration at Scale (10 tasks):

- T068-T077: 50 routes to createHandler()

Phase 17 — Final Verification (7 tasks, always last):

- T061-T067
  </remaining_work>

<decisions_made>

- process.env exemptions: NODE_TLS_REJECT_UNAUTHORIZED (TLS runtime mutation), HOSTNAME (OS var), SHELL (OS var), NODE_ENV in logger.ts (circular import risk with env.ts)
- KISMET_API_URL given .default('http://localhost:2501') — was previously required with no default, now has default for backward compat
- KISMET_USER default changed from 'kismet' (contract) to 'admin' (matching actual .env.example and existing code)
- offnet-utilities.ts localhost:8080 left as-is — client-side data file, can't import server env
- cors.ts and websocket-server.ts localhost allowlists left as security baselines, not configurable
- T041 partially done (line 76 migrated to os.userInfo().username), check line 183
  </decisions_made>

<blockers>

- Phase 8b-e blocked on user approval for 4 npm package installs
- RPi 5 memory: never run concurrent svelte-check or full test suite while Antigravity is active
  </blockers>

<context>
Following MVP-first strategy from tasks.md: Phase 13 (DRY) next because it has the
MAC-to-angle correctness bug fix (T040) and high operational value. Then Phase 14
(logging), then Phase 8f (client fetch), then Phase 18 (bulk route migration).
Phase 15 (decomposition) should come after migration phases since they change file sizes.
</context>

<next_action>
Start with Phase 13 parallel creation tasks: T036 (delay.ts), T038 (GEO constants),
T080 (kismet-geo-helpers.ts), T081 (GPS coord validation), T083 (lookup table),
T084 (gpsd.sock env var) — all touch independent files, can be done in parallel.
Then do the sequential migration tasks: T037, T039, T040, T041, T082.
Read tasks.md for full task details: specs/016-code-expressiveness/tasks.md
</next_action>
