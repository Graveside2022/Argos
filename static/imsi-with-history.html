<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>IMSI Capture - With Historical Data</title>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				margin: 0;
				padding: 20px;
				background: #0f172a;
				color: #f8fafc;
			}
			.container {
				max-width: 100%;
				margin: 0 auto;
			}
			.status {
				padding: 10px;
				background: #1e293b;
				border-radius: 8px;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.status.connected {
				border-left: 4px solid #10b981;
			}
			.status.disconnected {
				border-left: 4px solid #ef4444;
			}
			.status.loading {
				border-left: 4px solid #f59e0b;
			}
			table {
				width: 100%;
				border-collapse: collapse;
				background: #1e293b;
				border-radius: 8px;
				overflow: hidden;
			}
			th {
				background: #334155;
				padding: 12px;
				text-align: left;
				font-weight: 600;
				color: #f8fafc;
				position: sticky;
				top: 0;
				z-index: 10;
			}
			td {
				padding: 10px 12px;
				border-top: 1px solid #334155;
			}
			tr:hover {
				background: #2d3748;
			}
			.new-row {
				animation: highlight 2s ease;
			}
			@keyframes highlight {
				0% {
					background: #3b82f6;
				}
				100% {
					background: transparent;
				}
			}
			.stats {
				display: flex;
				gap: 20px;
				margin-bottom: 20px;
			}
			.stat-card {
				background: #1e293b;
				padding: 15px;
				border-radius: 8px;
				flex: 1;
			}
			.stat-value {
				font-size: 24px;
				font-weight: bold;
				color: #3b82f6;
			}
			.stat-label {
				font-size: 12px;
				color: #94a3b8;
				text-transform: uppercase;
				margin-top: 5px;
			}
			.country-flag {
				font-size: 20px;
				margin-right: 5px;
			}
			.loading-spinner {
				border: 3px solid #334155;
				border-top: 3px solid #3b82f6;
				border-radius: 50%;
				width: 20px;
				height: 20px;
				animation: spin 1s linear infinite;
				display: inline-block;
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
		</style>
		<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
	</head>
	<body>
		<div class="container">
			<div id="status" class="status loading">
				<div>
					<span id="statusText">Connecting to GSM Evil...</span>
					<span id="dataStatus"></span>
				</div>
				<div class="loading-spinner" id="spinner"></div>
			</div>

			<div class="stats">
				<div class="stat-card">
					<div class="stat-value" id="totalCount">0</div>
					<div class="stat-label">Total IMSIs</div>
				</div>
				<div class="stat-card">
					<div class="stat-value" id="newCount">0</div>
					<div class="stat-label">New This Session</div>
				</div>
				<div class="stat-card">
					<div class="stat-value" id="countryCount">0</div>
					<div class="stat-label">Countries</div>
				</div>
			</div>

			<table id="imsiTable">
				<thead>
					<tr>
						<th>ID</th>
						<th>IMSI</th>
						<th>TMSI</th>
						<th>Country</th>
						<th>MCC</th>
						<th>MNC</th>
						<th>LAC</th>
						<th>CI</th>
						<th>Time</th>
					</tr>
				</thead>
				<tbody id="tableBody"></tbody>
			</table>
		</div>

		<script>
			// MCC to country mapping
			const mccCountryMap = {
				262: { name: 'Germany', flag: '🇩🇪' },
				214: { name: 'Spain', flag: '🇪🇸' },
				515: { name: 'Philippines', flag: '🇵🇭' },
				604: { name: 'Morocco', flag: '🇲🇦' },
				231: { name: 'Slovakia', flag: '🇸🇰' },
				208: { name: 'France', flag: '🇫🇷' },
				234: { name: 'United Kingdom', flag: '🇬🇧' },
				310: { name: 'United States', flag: '🇺🇸' },
				311: { name: 'United States', flag: '🇺🇸' },
				312: { name: 'United States', flag: '🇺🇸' },
				313: { name: 'United States', flag: '🇺🇸' }
			};

			let allIMSIs = new Map();
			let sessionStartId = 0;
			let countries = new Set();
			let socket = null;
			let reconnectAttempts = 0;
			const maxReconnectAttempts = 10;

			function updateStatus(text, className) {
				const statusEl = document.getElementById('status');
				const statusText = document.getElementById('statusText');
				const spinner = document.getElementById('spinner');

				statusEl.className = 'status ' + className;
				statusText.textContent = text;

				if (className === 'connected') {
					spinner.style.display = 'none';
				} else if (className === 'loading') {
					spinner.style.display = 'inline-block';
				} else {
					spinner.style.display = 'none';
				}
			}

			function getCountryInfo(mcc) {
				return mccCountryMap[mcc] || { name: 'Unknown', flag: '🌍' };
			}

			function addIMSI(data, isNew = false) {
				const [id, imsi, tmsi, mcc, mnc, lac, ci, time] = data;

				// Track the IMSI
				if (!allIMSIs.has(imsi)) {
					allIMSIs.set(imsi, data);
					const country = getCountryInfo(mcc);
					countries.add(country.name);

					// Add to table
					const tbody = document.getElementById('tableBody');
					const row = tbody.insertRow(0); // Insert at top

					if (isNew) {
						row.className = 'new-row';
					}

					row.innerHTML = `
                <td>${id}</td>
                <td><strong>${imsi}</strong></td>
                <td>${tmsi || '-'}</td>
                <td><span class="country-flag">${country.flag}</span>${country.name}</td>
                <td>${mcc}</td>
                <td>${mnc}</td>
                <td>${lac}</td>
                <td>${ci}</td>
                <td>${time}</td>
            `;

					updateStats();
				}
			}

			function updateStats() {
				document.getElementById('totalCount').textContent = allIMSIs.size;
				document.getElementById('newCount').textContent = Array.from(
					allIMSIs.values()
				).filter((d) => d[0] > sessionStartId).length;
				document.getElementById('countryCount').textContent = countries.size;
			}

			function loadHistoricalData() {
				console.log('[IMSI] Requesting historical data...');

				// Try fetching from database directly as backup
				fetch('/api/gsm-evil/imsi-data')
					.then((res) => res.json())
					.then((data) => {
						if (data.success && data.imsis) {
							console.log(
								`[IMSI] Loaded ${data.imsis.length} historical records from API`
							);
							document.getElementById('dataStatus').textContent =
								` - Loaded ${data.imsis.length} historical records`;

							// Sort by ID descending
							data.imsis.sort((a, b) => b[0] - a[0]);

							// Add all historical data
							data.imsis.forEach((imsi) => addIMSI(imsi, false));

							// Track the highest ID for identifying new captures
							if (data.imsis.length > 0) {
								sessionStartId = Math.max(...data.imsis.map((d) => d[0]));
							}
						}
					})
					.catch((err) => {
						console.error('[IMSI] Failed to load historical data from API:', err);
					});
			}

			function connectSocket() {
				const host = window.location.hostname;
				const socketUrl = `http://${host}:8080`;

				console.log(`[IMSI] Connecting to Socket.IO at ${socketUrl}...`);
				updateStatus(
					`Connecting to GSM Evil... (Attempt ${reconnectAttempts + 1})`,
					'loading'
				);

				socket = io(socketUrl, {
					transports: ['websocket', 'polling'],
					reconnection: true,
					reconnectionAttempts: maxReconnectAttempts,
					reconnectionDelay: 2000,
					timeout: 10000
				});

				socket.on('connect', () => {
					console.log('[IMSI] Socket.IO connected successfully');
					updateStatus('Connected to GSM Evil - Waiting for IMSI captures', 'connected');
					reconnectAttempts = 0;

					// Request historical data through socket
					console.log('[IMSI] Requesting historical data via socket...');
					socket.emit('imsi_data', 'get');

					// Also load from API as backup
					setTimeout(() => {
						if (allIMSIs.size === 0) {
							console.log('[IMSI] No data received via socket, trying API...');
							loadHistoricalData();
						}
					}, 2000);
				});

				socket.on('imsi_data', (data) => {
					console.log('[IMSI] Received historical data:', data.length, 'records');
					if (Array.isArray(data)) {
						document.getElementById('dataStatus').textContent =
							` - Loaded ${data.length} historical records`;

						// Sort by ID descending
						data.sort((a, b) => b[0] - a[0]);

						// Add all historical data
						data.forEach((imsi) => addIMSI(imsi, false));

						// Track the highest ID
						if (data.length > 0) {
							sessionStartId = Math.max(...data.map((d) => d[0]));
						}
					}
				});

				socket.on('imsi', (data) => {
					console.log('[IMSI] New IMSI captured:', data);
					addIMSI(data, true);
					updateStatus(`Connected - Last capture at ${data[7]}`, 'connected');
				});

				socket.on('disconnect', () => {
					console.log('[IMSI] Socket.IO disconnected');
					updateStatus('Disconnected from GSM Evil', 'disconnected');
				});

				socket.on('connect_error', (error) => {
					console.error('[IMSI] Connection error:', error.message);
					reconnectAttempts++;

					if (reconnectAttempts >= maxReconnectAttempts) {
						updateStatus(
							'Failed to connect to GSM Evil - Check if service is running',
							'disconnected'
						);

						// Try to at least load historical data from API
						loadHistoricalData();
					} else {
						updateStatus(
							`Connection failed - Retrying... (${reconnectAttempts}/${maxReconnectAttempts})`,
							'loading'
						);
					}
				});
			}

			// Initialize on page load
			window.addEventListener('load', () => {
				console.log('[IMSI] Page loaded, initializing...');
				connectSocket();
			});
		</script>
	</body>
</html>
